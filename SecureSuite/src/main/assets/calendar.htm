<!--
  ~ Copyright (c) 2017. Nuvolect LLC
  -->

<!DOCTYPE html>

<html ng-app="myApp" ng-controller="myController">
<head>
    <title>Calendar</title>

    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
    <link href="/css/fullcalendar.css" rel="stylesheet">

    <script src="/js/jquery-1.11.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
    <script src="/js/ui-bootstrap-tpls-2.5.0.min.js"></script>

    <script src="/js/moment.js"></script>
    <script src="/js/fullcalendar.js"></script>
    <script src="/js/calendar.js"></script>

</head>

<body>

<div ng-include="'/navbar.htm'"></div>
<div class="calendar-padding" style="background: white;">

    <p>
        <button type="button" class="btn btn-link" data-toggle="modal"
                data-target=".new-event-modal">Create event</button>
    </p>
    <div ui-calendar="uiConfig.calendar" class="span8 calendar" ng-model="eventSources" calendar="myCalendar"></div>

    <h4>{{ alertMessage }}</h4>
</div>

<br>
<br>
<div ng-include="'/footer.htm'"></div>

<!--Angular template for modal dialog code structure starts here-->
<script type="text/ng-template" id="modalContent.html">
    <div class="modal-header">
        <button type="button" class="close" ng-click="cancel()"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title">Event</h3>
    </div>
    <div class="modal-body">
        <div style="color:red">{{Message}}</div>
        <div class="form-group">
            <label>Event Title : </label>
            <input type="text" ng-model="NewEvent.title" autofocus class="form-control" />
        </div>
        <div class="form-group">
            <label>Description : </label>
            <input type="text" ng-model="NewEvent.description" class="form-control" />
        </div>
            When<br>
            <strong>{{SlotRange}}</strong>
        </div>

    </div>
    <div class="modal-footer">
        <button class="btn btn-info" type="button" ng-click="edit()">Edit</button>
        <button class="btn btn-primary" type="button" ng-click="save()">Save</button>
        <button class="btn btn-danger" type="button" ng-show="NewEvent.id > 0" ng-click="delete()">Delete</button>
        <button class="btn btn-warning" type="button" ng-click="cancel()">Cancel</button>

    </div>
    <!--Angular modal dialog code ends here-->
</script>

<script>

var app = angular.module('myApp', ['ui.calendar', 'ui.bootstrap']);


app.controller('myController', function($scope, $http, uiCalendarConfig, $uibModal) {

  $scope.year = new Date().getFullYear(); // footer copyright year

   $scope.SelectedEvent = null;
    var isFirstTime = true;
    $scope.events = [];
    $scope.eventSources = [$scope.events];

    $scope.NewEvent = {};
    //this function for get datetime from json date
    function getDate(datetime) {
        if (datetime != null) {
            var mili = datetime.replace(/\/Date\((-?\d+)\)\//, '$1');
            return new Date(parseInt(mili));
        }
        else {
            return "";
        }
    }
    // this function clears clender enents
    function clearCalendar() {
        if (uiCalendarConfig.calendars.myCalendar != null) {
            uiCalendarConfig.calendars.myCalendar.fullCalendar('removeEvents');
            uiCalendarConfig.calendars.myCalendar.fullCalendar('unselect');
        }
    }
    //Load events from server to display on calendar
    function populate() {
        clearCalendar();

        var view = uiCalendarConfig.calendars.myCalendar.fullCalendar('getView');
        var start = view.start.format();
        var end = view.end.format();
        $http.get('/calendar/getevents', {
            cache: false,
            params: { "start": start, "end" : end}
        }).then(function (data) {
            $scope.events.slice(0, $scope.events.length);

            angular.forEach(data.data, function (value) {

                $scope.events.push({
                    id: value.id,
                    title: value.title,
                    description: value.description,
                    start: value.start,
                    end: value.end,
                    allDay: value.allDay,
                    stick: true
                });
            });
        });
    }
    <!--populate();-->

    //UI- calendar configuration
    $scope.uiConfig = {
        calendar: {
            utc: true,
            transmitTZD: true,
            allDay: false,
            height: 450,
            editable: true,
            displayEventTime: false,
            header: {
                left:'today prev,next title',
                center: '',
                right: 'month,agendaWeek,agendaDay,listDay,listMonth,listWeek,listYear'
            },
            timeFormat: {
                month: ' ', // for hide on month view
                agenda: 'h:mm t'
            },
            selectable: true,
            selectHelper: true,
            events: '/calendar/events',

            refetchResourcesOnNavigate: true,
            resources: '/calendar/resources',

            select: function(start, end){
                $scope.NewEvent = {
                    id: 0,
                    start: start,
                    end: end,
                    allDay: false,
                    title: '',
                    description: ''
                }
                $scope.showModal();
            },
            eventClick: function (event) {
                $scope.SelectedEvent = event;
                $scope.NewEvent = {
                    id: event.id,
                    start: event.start,
                    end: event.end,
                    allDay: false,
                    title: event.title,
                    description: event.description
                }
                $scope.showModal();
            },
            eventAfterAllRender: function () {
                if ($scope.events.length > 0 && isFirstTime) {
                    uiCalendarConfig.calendars.myCalendar.fullCalendar('gotoDate', $scope.events[0].start);
                    isFirstTime = false;
                }
            }
        }
    };

    //This function shows bootstrap modal dialog
    $scope.showModal = function () {
        $scope.option = {
            templateUrl: 'modalContent.html',
            controller: 'modalController',
            backdrop: 'static',
            resolve: {
                NewEvent: function () {
                    return $scope.NewEvent;
                }
            }
        };
        //CRUD operations on Calendar starts here
        var modal = $uibModal.open($scope.option);

        modal.result.then(function (data) {

            $scope.NewEvent = data.event;
            $scope.NewEvent.start = data.event.start.format();
            $scope.NewEvent.end = data.event.end.format();

            switch (data.operation) {

                case 'save':            //save

                    $http.post("/calendar/save", {data: $scope.NewEvent} )
                    .then(function (response) {

                        if (response.data.success) {
                            populate();
                        }
                    })
                    break;

                case 'delete':          //delete

                    $http.post("/calendar/delete", {data: $scope.NewEvent} )
                    .then(function (response) {

                        if (response.data.success) {
                            populate();
                        }
                    })
                    break;
                default:
                    break;
            }
        }, function () {
            console.log('Modal dialog closed');
        })
    }

})

app.factory('calService', function() {

    var savedData = {}

    function set(data) {
        savedData = data;
    }

    function get() {
        return savedData;
    }

    return {
        set: set,
        get: get
    }
});


app.controller('modalController',
            ['$scope','$rootScope','calService','$window','$uibModalInstance','NewEvent',
    function ($scope,  $rootScope,  calService,  $window,  $uibModalInstance,  NewEvent) {

    $scope.NewEvent = NewEvent;
    $scope.Message = "";

    var fromDate = moment(NewEvent.start).format('YYYY/MM/DD LT');
    var endDate = moment(NewEvent.end).format('YYYY/MM/DD LT');
    $scope.SlotRange = fromDate + " - " + endDate;

    $scope.save = function () {
        if ($scope.NewEvent.title.trim() != "") {
            $uibModalInstance.close({ event: $scope.NewEvent, operation: 'save'});
        }
        else {
            $scope.Message = "Event title required!";
        }
    }
    $scope.edit = function () {

        // Save to be picked up in destination page controller
        $rootScope.calEventData = $scope.NewEvent;
        calService.set($scope.NewEvent);

        var test = calService.get();

        $uibModalInstance.dismiss('cancel');

        $window.location.href = '/event_edit.htm';
    }
    $scope.delete = function () {
        $uibModalInstance.close({ event: $scope.NewEvent, operation: 'delete' });
    }
    $scope.cancel = function () {
        $uibModalInstance.dismiss('cancel');
    }
}]);

</script>
</body>
</html>
